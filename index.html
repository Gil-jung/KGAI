<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph</title>
    <!-- Cytoscape.js 라이브러리 불러오기 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <style>
        #cy {
            width: 100%;
            height: 100vh;
            display: block;
        }
    </style>
</head>
<body>
    <div style="padding: 20px; background-color: #f7f7f7; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <input type="text" id="search" placeholder="Search for a keyword..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
    </div>    
    <div id="no-results" style="color: red; padding: 10px; display: none;">No results found</div>
    <div id="description" style="padding: 20px; border: 1px solid #ccc;"></div>
    <div id="cy" style="width: 100%; height: calc(100vh - 120px); display: block; background-color: #fff; margin: 0 auto; border: 1px solid #ddd; border-radius: 4px;"></div>
    <body style="font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 0;">

    <script>
        // JSON 파일에서 그래프 데이터 불러오기
        fetch('graph.json')
            .then(response => response.json())
            .then(data => {
                // Cytoscape 초기화
                var cy = cytoscape({
                    container: document.getElementById('cy'), // 그래프가 렌더링될 HTML 요소
                    elements: {
                        nodes: data.nodes.map(node => ({
                            data: { id: node.id, label: node.label }
                        })),
                        edges: data.edges.map(edge => ({
                            data: { source: edge.from, target: edge.to, label: edge.label }
                        }))
                    },
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'text-valign': 'center',
                                'color': '#000',
                                'background-color': '#61bffc'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'label': 'data(label)',
                                'width': 2,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle'
                            }
                        }
                    ],
                    layout: {
                        name: 'cose', // 레이아웃 방식 (e.g., grid, circle, cose 등)
                        padding: 10
                    }
                });

                // 노드 클릭 이벤트 처리
                cy.on('tap', 'node', function(evt) {
                    var node = evt.target;
                    var keyword = node.data('id');
                    // 해당 키워드의 설명을 마크다운 파일에서 가져와 표시
                    fetch(`docs/${keyword}.md`)
                        .then(response => response.text())
                        .then(text => {
                            document.getElementById('description').innerHTML = `<h2>${keyword}</h2><p>${text}</p>`;
                        });
                });

                cy.on('mouseover', 'node', function(event) {
                    var node = event.target;
                    var tooltip = document.createElement('div');
                    tooltip.id = 'tooltip';
                    tooltip.innerHTML = `
                        <strong>${node.data('label')}</strong><br>
                        ${node.data('description')}
                    `;
                    document.body.appendChild(tooltip);

                    tooltip.style.position = 'absolute';
                    tooltip.style.left = event.originalEvent.pageX + 'px';
                    tooltip.style.top = event.originalEvent.pageY + 'px';
                    tooltip.style.backgroundColor = '#fff';
                    tooltip.style.border = '1px solid #ccc';
                    tooltip.style.padding = '10px';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                });

                cy.on('mouseout', 'node', function() {
                    var tooltip = document.getElementById('tooltip');
                    if (tooltip) {
                        document.body.removeChild(tooltip);
                    }
                });

                cy.style()
                    .selector('edge')
                    .style({
                        'width': function(ele) {
                            return ele.data('weight') || 2;  // 엣지의 중요도에 따라 두께 설정
                        },
                        'line-color': function(ele) {
                            return ele.data('color') || '#ccc';  // 엣지의 색상 설정
                        },
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle'
                });

                cy.style()
                    .selector('.highlighted')
                    .style({
                        'line-color': '#f00',
                        'target-arrow-color': '#f00',
                        'transition-property': 'line-color, target-arrow-color',
                        'transition-duration': '0.5s'
                    });

                    cy.on('tap', 'edge', function(e) {
                        var edge = e.target;
                        edge.addClass('highlighted');

                        setTimeout(function() {
                            edge.removeClass('highlighted');
                        }, 1000);
                });

                cy.layout({
                    name: 'cose',  // 또는 'klay', 'cola' 등
                    padding: 10,
                    nodeRepulsion: 4000,
                    idealEdgeLength: 100,
                    edgeElasticity: 100,
                    animate: true
                }).run();

                cy.nodes().forEach(function(node) {
                    var group = node.data('group');
                    node.style('background-color', group === 'Group A' ? '#ff7f0e' : '#1f77b4');
                });

                function searchNodes(query) {
                    var results = cy.nodes().filter(function(node) {
                        return node.data('label').toLowerCase().includes(query.toLowerCase());
                    });

                    cy.elements().removeClass('faded');
                    cy.elements().not(results).addClass('faded');
                }

                function filterNodes(attribute, value) {
                    var results = cy.nodes().filter(function(node) {
                        return node.data(attribute) === value;
                    });

                    cy.elements().removeClass('hidden');
                    cy.elements().not(results).addClass('hidden');
                }

                cy.nodes().animate({
                    style: { 'background-color': '#61bffc' },
                    duration: 1000
                });

                document.getElementById('search').addEventListener('input', function(e) {
                    var query = e.target.value.toLowerCase();
                    
                    // 모든 노드와 엣지를 숨기기
                    cy.elements().hide();

                    // 검색어와 일치하는 노드를 찾기
                    var matchingNodes = cy.nodes().filter(function(node) {
                        return node.data('label').toLowerCase().includes(query);
                    });

                    if (matchingNodes.length > 0) {
                        // 일치하는 노드와 관련된 엣지 및 인접 노드 표시
                        matchingNodes.show();
                        matchingNodes.connectedEdges().show();
                        matchingNodes.connectedEdges().connectedNodes().show();

                        // 일치하는 노드를 강조 표시
                        matchingNodes.style({
                            'background-color': '#f00',
                            'color': '#fff'
                        });
                    } else {
                        // 검색어가 없으면 모든 요소를 다시 표시
                        cy.elements().show();
                        cy.nodes().style({
                            'background-color': '#61bffc',
                            'color': '#000'
                        });
                    }
                });

                document.getElementById('search').addEventListener('input', function(e) {
                    var query = e.target.value.toLowerCase();
                    var noResultsMessage = document.getElementById('no-results');

                    // 모든 노드와 엣지를 숨기기
                    cy.elements().hide();

                    // 검색어와 일치하는 노드를 찾기
                    var matchingNodes = cy.nodes().filter(function(node) {
                        return node.data('label').toLowerCase().includes(query);
                    });

                    if (matchingNodes.length > 0) {
                        // "No results found" 메시지 숨기기
                        noResultsMessage.style.display = 'none';

                        // 일치하는 노드와 관련된 엣지 및 인접 노드 표시
                        matchingNodes.show();
                        matchingNodes.connectedEdges().show();
                        matchingNodes.connectedEdges().connectedNodes().show();

                        // 일치하는 노드를 강조 표시
                        matchingNodes.style({
                            'background-color': '#f00',
                            'color': '#fff',
                            'border-width': '2px',
                            'border-color': '#000'
                        });
                    } else {
                        // "No results found" 메시지 표시
                        noResultsMessage.style.display = 'block';

                        // 모든 요소를 다시 표시 (검색어가 비어 있을 때)
                        if (query === '') {
                            cy.elements().show();
                            cy.nodes().style({
                                'background-color': '#61bffc',
                                'color': '#000',
                                'border-width': '1px',
                                'border-color': '#ccc'
                            });

                            noResultsMessage.style.display = 'none';
                        }
                    }
                });


            });
    </script>
</body>
</html>
